#!/usr/bin/env ruby
require 'uri'
require 'net/http'
require 'kconv'

$KCODE='u'

def redirect(url, limit = 10)
  raise 'HTTP Redirection exceeded limit' if limit == 0
  uri = URI.parse(url);
  Net::HTTP.start(uri.host, uri.port) do |http|
    case response = http.head(uri.request_uri)
    when Net::HTTPSuccess
      url
    when Net::HTTPRedirection
      redirect(response['location'], limit - 1)
    else
      response.error!
    end
  end
end

YOUTUBE_URL_PATTERN = 'http://www.youtube.com/watch?v=%s'
def youtube_url(id)
  YOUTUBE_URL_PATTERN % id
end

YOUTUBE_ID_PATTERN = /[?&]v=([a-zA-Z0-9\_\-]+)/
def get_ids(lines)
  lines.map{|line| $1 if !(/^#/ === line) && YOUTUBE_ID_PATTERN === line}.compact
end

YOUTUBE_T_PATTERN = /&t=([^&]+)/
def find_t(body)
  if YOUTUBE_T_PATTERN === body
    return URI.unescape($1)
  end
  raise "No t value found in:\n\t" << body.split(/\r?\n/).join("\n\t")
end

YOUTUBE_TITLE_PARTTERN = /<meta name="title" content="(.*)">/
def find_title(body)
  YOUTUBE_TITLE_PARTTERN === body ? $1 : ""
end

INVALID_FILENAME_PATTERNS = [/[ ã€€]+/, /\//, /\000/]
def filename_for(title)
  filename = title.to_s
  INVALID_FILENAME_PATTERNS.each do |pattern|
    filename.gsub!(pattern, '_')
  end
  filename
end

YOUTUBE_FORMATS = [37, 22, 18, 6]
YOUTUBE_GET_VIDEO_URL = 'http://www.youtube.com/get_video?video_id=%s&t=%s&fmt=%s'
def get_video_url(id, t)
  YOUTUBE_FORMATS.each do |fmt|
    begin
      url = redirect(YOUTUBE_GET_VIDEO_URL % [id, t, fmt])
      return url, fmt
    rescue
    end
  end
  raise "No video found id: #{id}"
end

puts "#/bin/sh"
get_ids(ARGF).each do |id|
  begin
    uri = URI.parse(youtube_url(id))
    response = Net::HTTP.start(uri.host, uri.port){|http| http.get(uri.request_uri)}
    body = response.body.toutf8
    t = find_t(body)
    video_url, fmt = get_video_url(id, t)
    title = find_title(body)
    filename = filename_for(title)
    puts "wget -O '#{filename}.mp4' '#{video_url}'"
    STDERR.puts "Video id: #{id} title: #{title} fmt: #{fmt}"
  rescue => e
    STDERR.puts "Exception: " << e
  end
end
